
<!DOCTYPE html>

<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Massages &amp; SPA — Rezerwacja</title>
<link href="assets/style.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

</head>
<body>
<div class="container">
<div class="header">
<div class="brand">
<img class="logo" alt="Massage &amp; SPA" src="assets/logo.svg"/>
</div>
</div>
<div class="card">
<h2>Rezerwacja</h2>
<form class="grid two" id="form">
<div>
<label>Imię i nazwisko *</label>
<input class="input" id="name" required=""/>
</div>
<div>
<label>Email *</label>
<input class="input" id="email" required="" type="email"/>
</div>
<div>
<label>Telefon *</label>
<input class="input" id="phone" required="" type="tel"/>
</div>
<div>
<label>Adres</label>
<input class="input" id="address" placeholder="Ulica, miasto"/>
</div>
<div>
<label>Zabieg *</label>
<select class="input" id="service"></select>
</div>
<div>
<label>Data *</label>
<input class="input" id="date" required="" type="date"/>
</div>
<div>
<label>Godzina *</label>
<select class="input" id="time"><option>Wybierz datę…</option></select>
</div>
<div class="grid" style="grid-column:1/-1">
<label>Uwagi</label>
<textarea class="input" id="notes" placeholder="Np. preferencje, dolegliwości…" rows="4"></textarea>
</div>
<div class="inline" style="grid-column:1/-1">
<input id="rodo" style="width:18px;height:18px" type="checkbox"/>
<label for="rodo" id="rodoLbl">Wyrażam zgodę na przetwarzanie danych osobowych w celu realizacji rezerwacji.</label>
</div>
<div style="grid-column:1/-1;display:flex;gap:10px">
<button class="btn" type="submit">Rezerwuj</button>
</div>
</form>
</div>
<div class="footer">© Massages &amp; SPA • <span id="contact"></span></div>
</div>

<script>
  // SUPABASE → render #service (nadpisujemy select, więc nie będzie duplikatów)
  document.addEventListener('DOMContentLoaded', async () => {
    const sel = document.getElementById('service');
    if (!sel || !window.sb) return;

    try {
      const { data, error } = await window.sb
        .from('services')
        .select('id, name, price, duration_min, active')
        .eq('active', true)
        .order('name', { ascending: true });

      if (error) {
        console.warn('[public] services error:', error);
        return;
      }

      // Nadpisz select – znikają ewentualne stare opcje
      sel.innerHTML = '<option value="">Wybierz zabieg</option>' + 
        (data || []).map(s => {
          const price = (Number(s.price) || 0).toFixed(2).replace('.', ',');
          return `<option value="${s.id}" data-name="${s.name}">${s.name} — ${price} zł</option>`;
        }).join('');

      // (opcjonalnie) Jeżeli Twój app.js ma własny renderer – odśwież go:
      if (typeof window.renderServicesSelect === 'function') {
        window.renderServicesSelect();
      }
    } catch (e) {
      console.warn('[public] services crash:', e);
    }
  });
</script>

script>
  async function dbLoadServices(){
    const { data, error } = await sb
      .from('services')
      .select('id, name, price, duration_min, active')
      .eq('active', true)
      .order('name', { ascending:true });
    if(error){ console.warn('[public] services error:', error); return []; }
    return data || [];
  }

  async function dbEnsureClient({name, email, phone, address}){
    // spróbuj znaleźć po e-mailu
    let { data: found, error: e1 } = await sb
      .from('clients')
      .select('id')
      .ilike('email', email)
      .single();
    if (!e1 && found) return found.id;

    // jeśli nie ma — utwórz
    const { data: created, error: e2 } = await sb
      .from('clients')
      .insert({ name, email, phone, address })
      .select('id')
      .single();
    if(e2){ console.warn('[public] create client error:', e2); return null; }
    return created?.id || null;
  }

  async function dbCreateBooking({slot_id, service_id, client_id, notes}){
    const { data: booking, error: e1 } = await sb
      .from('bookings')
      .insert({ slot_id, service_id, client_id, notes })
      .select('id, created_at')
      .single();
    if(e1){ console.warn('[public] booking insert error:', e1); return { ok:false, error:e1 }; }

    // oznacz slot jako zajęty
    const { error: e2 } = await sb
      .from('slots')
      .update({ taken: true })
      .eq('id', slot_id);
    if(e2){ console.warn('[public] slot mark taken error:', e2); }

    return { ok:true, booking };
  }
</script>



<script>
(function(){
  const dateEl = document.getElementById('date');
  const timeEl = document.getElementById('time');
  if(!dateEl || !timeEl) return;

  function buildMap(){
    const slots    = Store.get('slots',[]) || [];
    const bookings = Store.get('bookings',[]) || [];
    const taken = new Set(bookings.map(b => b.slotId));
    const free = slots.filter(s => !taken.has(s.id));

    const map = {}; // YYYY-MM-DD -> [slotObj]
    free.forEach(s=>{
      const d = new Date(s.when);
      if(isNaN(d)) return;
      const key = d.toISOString().slice(0,10);
      (map[key] ||= []).push(s);
    });
    Object.keys(map).forEach(k => map[k].sort((a,b)=> new Date(a.when)-new Date(b.when)));
    return map;
  }

  function fillTimes(dateStr,map){
    timeEl.innerHTML='';
    const arr = map[dateStr]||[];
    if(!arr.length){
      const o=document.createElement('option');
      o.value=''; o.textContent='Brak wolnych godzin'; o.disabled=true; o.selected=true;
      timeEl.appendChild(o); timeEl.disabled=true; return;
    }
    const ph=document.createElement('option');
    ph.value=''; ph.textContent='Wybierz godzinę…'; ph.disabled=true; ph.selected=true;
    timeEl.appendChild(ph);
    arr.forEach(s=>{
      const o=document.createElement('option');
      o.value = s.id;
      o.textContent = new Date(s.when).toLocaleTimeString('pl-PL',{hour:'2-digit',minute:'2-digit'});
      timeEl.appendChild(o);
    });
    timeEl.disabled=false;
  }

  function fmt(d){const z=n=>('0'+n).slice(-2);return d.getFullYear()+'-'+z(d.getMonth()+1)+'-'+z(d.getDate());}

  function init(){
    const map = buildMap();
    if(typeof flatpickr==='function'){
      window.fp = flatpickr(dateEl,{
        dateFormat:'Y-m-d',
        disableMobile:true,
        enable:Object.keys(map),
        onChange:(_,str)=>{ if(str) fillTimes(str,map); },
        onDayCreate:(_,__,___,dayElem)=>{
          const key=fmt(dayElem.dateObj);
          if(map[key]) dayElem.classList.add('fp-has-slot');
        }
      });
      // auto ustaw pierwszy dostępny dzień
      const days = Object.keys(map);
      if(days.length){ window.fp.setDate(days[0],true); fillTimes(days[0],map); }
      const s=document.createElement('style');
      s.textContent='.flatpickr-day.fp-has-slot{box-shadow:inset 0 0 0 2px rgba(99,255,185,.9);border-radius:8px}';
      document.head.appendChild(s);
    }else{
      dateEl.addEventListener('change',()=>fillTimes(dateEl.value,map),{once:true});
    }
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',init);
  else init();

  // na żywo – jak admin doda slot
  window.addEventListener('storage',(e)=>{
    if(e.key==='slots' || e.key==='bookings') init();
  });
})();
</script>
<script>
  // SUPABASE → LocalStorage: services + slots, potem odśwież UI
  document.addEventListener('DOMContentLoaded', async () => {
    if (!window.sb) return;
    try {
      const [{ data: svc, error: e1 }, { data: slots, error: e2 }] = await Promise.all([
        window.sb.from('services')
          .select('id, name, price, duration_min, active')
          .eq('active', true)
          .order('name', { ascending: true }),
        window.sb.from('slots')
          .select('id, when, taken')
          .eq('taken', false)
          .order('when', { ascending: true })
      ]);

      if (!e1 && Array.isArray(svc)) {
        localStorage.setItem('services', JSON.stringify(svc));
        const sel = document.getElementById('service');
        if (sel) {
          sel.innerHTML = '<option value="">Wybierz zabieg</option>' +
            svc.map(s => {
              const price = (Number(s.price) || 0).toFixed(2).replace('.', ',');
              return `<option value="${s.id}" data-name="${s.name}">${s.name} — ${price} zł</option>`;
            }).join('');
        }
      }

     
    } catch (err) {
      console.warn('[public sync] fail:', err);
    }
  });
</script>

<!-- Poprawny baner "dziękujemy" (poza <script>) -->
<style>
/* Pasek potwierdzenia – środek ekranu */
#bookingThanks {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);  /* środek ekranu */
  background: #27ae60;               /* zielony */
  color: #fff;
  padding: 10px 25px;                /* cienki pasek */
  border-radius: 6px;
  font-size: 15px;
  line-height: 1.3;
  display: none;
  z-index: 9999;
  box-shadow: 0 4px 15px rgba(0,0,0,.2);
  white-space: nowrap;               /* jeden wiersz */
}
#bookingThanks.show { display:block; }

</style>
<div id="bookingThanks">Dziękujemy za dokonanie rezerwacji, poczekaj na jej potwierdzenie!</div>
<!-- Toast / Banner -->
<div id="toast" style="position:fixed;left:50%;bottom:24px;transform:translateX(-50%) scale(0.98);opacity:0;z-index:9999;min-width:280px;max-width:90vw;padding:14px 18px;border-radius:12px;font:500 14px/1.4 system-ui,-apple-system,'Segoe UI',Roboto; box-shadow:0 8px 30px rgba(0,0,0,.22); transition:opacity .18s ease, transform .18s ease; pointer-events:none;">
  <span id="toast-text"></span>
</div>

<script>
window.addEventListener('storage', (e) => {
  if (e.key === 'slots') {
    // tu wywołaj swoją funkcję, która przebudowuje mapę dat/godzin
    // np. rebuildCalendarFromSlots();
    // i ewentualnie przeładuj flatpickr:
    if (window.fp && typeof window.fp.redraw === 'function') window.fp.redraw();
  }
});
</script>

<script>
(function(){
  const toast = document.getElementById('toast');
  const text  = document.getElementById('toast-text');
  if(!toast || !text) return;

  function paint(type){
    // tło i kolor na podstawie typu
    const bg = type === 'error' ? 'linear-gradient(135deg, #ff5252, #ff1744)'
            : type === 'warn'  ? 'linear-gradient(135deg, #ffb300, #ff9800)'
            :                    'linear-gradient(135deg, #2ecc71, #27ae60)'; // success
    toast.style.background = bg;
    toast.style.color = '#fff';
  }

  function showToast(msg, type='success', ttl=2600){
    text.textContent = msg;
    paint(type);
    toast.style.opacity = '1';
    toast.style.transform = 'translateX(-50%) scale(1)';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(-50%) scale(0.98)';
    }, ttl);
  }

  // Publiczne API – możesz wywołać z dowolnego miejsca:
  window.showSuccess = (m, ttl)=> showToast(m || 'Gotowe ✅', 'success', ttl);
  window.showError   = (m, ttl)=> showToast(m || 'Wystąpił błąd ❗', 'error', ttl);
  window.showWarn    = (m, ttl)=> showToast(m || 'Uwaga ⚠️', 'warn', ttl);

  // Przechwycenie wbudowanego alert(), żeby NIE dotykać app.js
  const nativeAlert = window.alert.bind(window);
  window.alert = function(msg){
    try{
      const s = String(msg || '');
      const lower = s.toLowerCase();
      const isError =
        lower.includes('błąd') ||
        lower.includes('blad') ||
        lower.includes('nie') && lower.includes('moż') ||
        lower.includes('zajęty') ||
        lower.includes('uzupełnij') ||
        lower.includes('invalid');
      const isSuccess =
        lower.includes('dziękuj') ||
        lower.includes('dziekuj') ||
        lower.includes('potwierdzono') ||
        lower.includes('zapisano') ||
        lower.includes('wysłano') || lower.includes('wyslano');

      if(isError)   showError(s);
      else if(isSuccess) showSuccess(s);
      else          showWarn(s);
    }catch(e){
      // w skrajności – pokaż native
      nativeAlert(msg);
    }
  };
})();
</script><script src="assets/store.js"></script>
<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Inicjalizacja Supabase -->
<script>
  const SUPABASE_URL = 'https://eibzijpelnmvbtslquun.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpYnppanBlbG5tdmJ0c2xxdXVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2MTE1OTcsImV4cCI6MjA3NDE4NzU5N30.Dp4u9PlhP-_pGmiNTHp5zSjrMUDfA_k2i85_71_9koo';
  window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
<script>
  // Klient: wywołanie Netlify Function z przeglądarki
  window.sendEmail = async ({ subject, html }) => {
    try {
      const r = await fetch('/.netlify/functions/send-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subject, html })
      });
      const body = await r.text();       // tekst lub JSON-tekst
      if (!r.ok) {
        console.warn('[MAIL] ERR', r.status, body);
        return { ok: false, status: r.status, body };
      }
      return { ok: true, status: r.status, body };
    } catch (e) {
      console.warn('[MAIL] fetch ERR', e);
      return { ok: false, error: e.message };
    }
  };
</script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  // wymuś pobranie slotów zaraz po starcie + po chwili
  if (window.pullPublicSlots) {
    window.pullPublicSlots();
    setTimeout(()=>window.pullPublicSlots(), 500);
  }
  // gdy karta wraca na wierzch
  window.addEventListener('focus', ()=>window.pullPublicSlots && window.pullPublicSlots());
});
</script>

<script src="assets/app.js"></script>
<!-- Prosty adapter na stronie publicznej -->
</body>
</html>


