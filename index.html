
<!DOCTYPE html>

<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Massage &amp; SPA — Rezerwacja</title>
<link href="assets/style.css" rel="stylesheet"/>
</head>
<body>
<div class="container">
<div class="header">
<div class="brand">
<img alt="Massage &amp; SPA" src="assets/logo.svg"/>
<h1>Massage &amp; SPA</h1>
</div>
<div>
<a class="btn secondary" href="admin.html">Panel admin</a>
</div>
</div>
<div class="card">
<h2>Rezerwacja</h2>
<form class="grid two" id="form">
<div>
<label>Imię i nazwisko *</label>
<input class="input" id="name" required=""/>
</div>
<div>
<label>Email *</label>
<input class="input" id="email" required="" type="email"/>
</div>
<div>
<label>Telefon *</label>
<input class="input" id="phone" required="" type="tel"/>
</div>
<div>
<label>Adres</label>
<input class="input" id="address" placeholder="Ulica, miasto"/>
</div>
<div>
<label>Zabieg *</label>
<select class="input" id="service"></select>
</div>
<div></div>
<div>
<label>Data *</label>
<input class="input" id="date" required="" type="date"/>
</div>
<div>
<label>Godzina *</label>
<select class="input" id="time"><option>Wybierz datę…</option></select>
</div>
<div class="grid" style="grid-column:1/-1">
<label>Uwagi</label>
<textarea class="input" id="notes" placeholder="Np. preferencje, dolegliwości…" rows="4"></textarea>
</div>
<div class="inline" style="grid-column:1/-1">
<input id="rodo" style="width:18px;height:18px" type="checkbox"/>
<label for="rodo" id="rodoLbl">Wyrażam zgodę na przetwarzanie danych osobowych w celu realizacji rezerwacji.</label>
</div>
<div style="grid-column:1/-1;display:flex;gap:10px">
<button class="btn" type="submit">Rezerwuj</button>
</div>
</form>
</div>
<div class="footer">© Massage &amp; SPA • <span id="contact"></span></div>
</div>
<script src="assets/store.js"></script>
<script src="assets/app.js"></script><script>(function(){  var DATE_SELECTORS=['#date','#bookingDate','#dateInput','input[name="date"]'];  var TIME_SELECTORS=['#time','#bookingTime','#timeSelect','select[name="time"]'];  function $(list){for(var i=0;i<list.length;i++){var el=document.querySelector(list[i]);if(el)return el}return null}  function injectCSS(css){var s=document.createElement('style');s.textContent=css;document.head.appendChild(s)}  function loadScript(src,cb){var s=document.createElement('script');s.src=src;s.onload=cb;document.head.appendChild(s)}  function loadCSS(href){var l=document.createElement('link');l.rel='stylesheet';l.href=href;document.head.appendChild(l)}  function parseSlots(){    var out=[];function add(d,t){if(!d||!t)return;if(!/^\d{4}-\d{2}-\d{2}$/.test(d))return;if(!/^\d{2}:\d{2}$/.test(t))return;out.push({date:d,time:t})}    for(var i=0;i<localStorage.length;i++){      var k=localStorage.key(i),v=null;try{v=JSON.parse(localStorage.getItem(k))}catch(e){v=null} if(!v)continue;      if(Array.isArray(v)&&v.length){        if(typeof v[0]==='object'&&'date'in v[0]&&'time'in v[0]){v.forEach(function(x){add(x.date,x.time)});continue}        if(typeof v[0]==='string'){v.forEach(function(s){var m=s.match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}:\d{2})$/);if(m)add(m[1],m[2])});continue}      }      if(v&&typeof v==='object'){        if(Array.isArray(v.slots)){v.slots.forEach(function(x){add(x.date,x.time)});continue}        var keys=Object.keys(v),used=false;        for(var j=0;j<keys.length;j++){var key=keys[j];if(/^\d{4}-\d{2}-\d{2}$/.test(key)&&Array.isArray(v[key])){v[key].forEach(function(t){add(key,String(t).slice(0,5))});used=true}}        if(used)continue;      }    }    return out;  }  function init(){    var dateEl=$(DATE_SELECTORS),timeEl=$(TIME_SELECTORS); if(!dateEl||!timeEl)return;    var slots=parseSlots(),days={}; slots.forEach(function(s){(days[s.date]||(days[s.date]=[])).includes(s.time)||days[s.date].push(s.time)});    var enabledDates=Object.keys(days);    if(typeof flatpickr!=='function'){console.warn('flatpickr not loaded');return}    flatpickr(dateEl,{      dateFormat:'Y-m-d',disableMobile:true,enable:enabledDates,      onDayCreate:function(_1,_2,_3,dayElem){        var y=dayElem.dateObj.getFullYear(),m=('0'+(dayElem.dateObj.getMonth()+1)).slice(-2),d=('0'+dayElem.dateObj.getDate()).slice(-2);        var key=y+'-'+m+'-'+d; if(days[key]) dayElem.classList.add('fp-has-slots');      },      onChange:function(selected){var sel=selected&&selected[0]; if(!sel)return;        var y=sel.getFullYear(),m=('0'+(sel.getMonth()+1)).slice(-2),d=('0'+sel.getDate()).slice(-2); var key=y+'-'+m+'-'+d;        while(timeEl.firstChild) timeEl.removeChild(timeEl.firstChild);        var times=(days[key]||[]).slice().sort();        if(!times.length){var o=document.createElement('option');o.value='';o.textContent='Brak wolnych godzin';o.disabled=true;o.selected=true;timeEl.appendChild(o);timeEl.disabled=true;return}        var ph=document.createElement('option');ph.value='';ph.textContent='Wybierz godzinę…';timeEl.appendChild(ph);        times.forEach(function(t){var o=document.createElement('option');o.value=t;o.textContent=t;timeEl.appendChild(o)}); timeEl.disabled=false;      }    });    injectCSS('.flatpickr-day.fp-has-slots{box-shadow:inset 0 0 0 2px rgba(72,222,151,.9);border-radius:8px}.flatpickr-day.fp-has-slots:hover{background:rgba(72,222,151,.15)}');  }  function boot(){    if(typeof flatpickr==='function'){init()}    else{loadCSS('https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css');loadScript('https://cdn.jsdelivr.net/npm/flatpickr',init)}  }  if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',boot);else boot();})();</script>
<script>
(function(){
  const dateEl = document.getElementById('date');
  const timeEl = document.getElementById('time');
  if(!dateEl || !timeEl) return;

  function buildMap(){
    const slots    = Store.get('slots',[]) || [];
    const bookings = Store.get('bookings',[]) || [];
    const taken = new Set(bookings.map(b=>b.slotId));
    const free = slots.filter(s=>!taken.has(s.id));

    const map = {};
    free.forEach(s=>{
      const d=new Date(s.when); if(isNaN(d)) return;
      const key=d.toISOString().slice(0,10);
      (map[key] ||= []).push(s);
    });
    Object.keys(map).forEach(k=> map[k].sort((a,b)=> new Date(a.when)-new Date(b.when)));
    return map;
  }

  function fillTimes(dateStr,map){
    timeEl.innerHTML='';
    const arr = map[dateStr]||[];
    if(!arr.length){
      const o=document.createElement('option'); o.value=''; o.text='Brak wolnych godzin'; o.disabled=true; o.selected=true;
      timeEl.appendChild(o); timeEl.disabled=true; return;
    }
    const ph=document.createElement('option'); ph.value=''; ph.text='Wybierz godzinę…'; ph.disabled=true; ph.selected=true;
    timeEl.appendChild(ph);
    arr.forEach(s=>{
      const o=document.createElement('option');
      o.value=s.id; // WAŻNE: id slota
      o.textContent=new Date(s.when).toLocaleTimeString('pl-PL',{hour:'2-digit',minute:'2-digit'});
      timeEl.appendChild(o);
    });
    timeEl.disabled=false;
  }

  function fmt(d){const z=n=>('0'+n).slice(-2); return d.getFullYear()+'-'+z(d.getMonth()+1)+'-'+z(d.getDate());}

  function init(){
    const map=buildMap();
    if(typeof flatpickr==='function'){
      window.fp=flatpickr(dateEl,{
        dateFormat:'Y-m-d',
        disableMobile:true,
        enable:Object.keys(map),
        onChange:(_,str)=>{ if(str) fillTimes(str,map); },
        onDayCreate:(_,__,___,dayElem)=>{
          const d=fmt(dayElem.dateObj); if(map[d]) dayElem.classList.add('has-slot');
        }
      });
      const days=Object.keys(map);
      if(days.length){ window.fp.setDate(days[0],true); fillTimes(days[0],map); }
      const s=document.createElement('style');
      s.textContent='.flatpickr-day.has-slot{box-shadow:inset 0 0 0 2px rgba(99,255,185,.9);border-radius:8px}';
      document.head.appendChild(s);
    } else {
      dateEl.addEventListener('change',()=>fillTimes(dateEl.value,map));
    }
  }

  function refresh(){ init(); }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',refresh); else refresh();

  window.addEventListener('storage',(e)=>{
    if(e.key==='slots' || e.key==='bookings') refresh();
  });
})();
</script>

<!-- Poprawny baner "dziękujemy" (poza <script>) -->
<style>
#bookingThanks {
  position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);
  background: #fff; color:#000; border:2px solid #000;
  padding: 14px 18px; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
  display:none; z-index: 9999; text-align:center;
}
#bookingThanks.show { display:block; animation: fadein .18s ease-out; }
@keyframes fadein { from { opacity:0; transform: translateX(-50%) translateY(6px);} to { opacity:1; transform: translateX(-50%) translateY(0);} }
</style>
<div id="bookingThanks">Dziękujemy za dokonanie rezerwacji, poczekaj na jej potwierdzenie!</div>
<!-- Toast / Banner -->
<div id="toast" style="position:fixed;left:50%;bottom:24px;transform:translateX(-50%) scale(0.98);opacity:0;z-index:9999;min-width:280px;max-width:90vw;padding:14px 18px;border-radius:12px;font:500 14px/1.4 system-ui,-apple-system,'Segoe UI',Roboto; box-shadow:0 8px 30px rgba(0,0,0,.22); transition:opacity .18s ease, transform .18s ease; pointer-events:none;">
  <span id="toast-text"></span>
</div>
<script>
/* Kill legacy slot keys + normalizacja 'slots' */
(function () {
  const LEGACY_KEYS = [
    'FREE_SLOTS', 'FREE_SLOTS_V2', 'freeSlotsISO', 'ms_slots_v6', 'slots_mirror'
  ];
  LEGACY_KEYS.forEach(k => localStorage.removeItem(k));

  // Zostawiamy tylko 'slots' jako źródło prawdy i czyścimy stare/niepoprawne
  let slots = [];
  try { slots = JSON.parse(localStorage.getItem('slots') || '[]'); } catch {}
  slots = (slots || [])
    .map(s => {
      const when = s.when || (s.date && s.time ? `${s.date}T${s.time}:00` : null);
      return when ? { id: s.id, when } : null;
    })
    .filter(Boolean)
    // wyrzuć przeszłość (zostaw tylko przyszłe)
    .filter(s => new Date(s.when).getTime() > Date.now());
  localStorage.setItem('slots', JSON.stringify(slots));

  // Flaga informacyjna – jeśli masz banner debug, pokaże: "klucz: slots"
  window.__SLOTS_KEY__ = 'slots';
})();
</script>
<script>
window.addEventListener('storage', (e) => {
  if (e.key === 'slots') {
    // tu wywołaj swoją funkcję, która przebudowuje mapę dat/godzin
    // np. rebuildCalendarFromSlots();
    // i ewentualnie przeładuj flatpickr:
    if (window.fp && typeof window.fp.redraw === 'function') window.fp.redraw();
  }
});
</script>

<script>
(function(){
  const toast = document.getElementById('toast');
  const text  = document.getElementById('toast-text');
  if(!toast || !text) return;

  function paint(type){
    // tło i kolor na podstawie typu
    const bg = type === 'error' ? 'linear-gradient(135deg, #ff5252, #ff1744)'
            : type === 'warn'  ? 'linear-gradient(135deg, #ffb300, #ff9800)'
            :                    'linear-gradient(135deg, #2ecc71, #27ae60)'; // success
    toast.style.background = bg;
    toast.style.color = '#fff';
  }

  function showToast(msg, type='success', ttl=2600){
    text.textContent = msg;
    paint(type);
    toast.style.opacity = '1';
    toast.style.transform = 'translateX(-50%) scale(1)';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(-50%) scale(0.98)';
    }, ttl);
  }

  // Publiczne API – możesz wywołać z dowolnego miejsca:
  window.showSuccess = (m, ttl)=> showToast(m || 'Gotowe ✅', 'success', ttl);
  window.showError   = (m, ttl)=> showToast(m || 'Wystąpił błąd ❗', 'error', ttl);
  window.showWarn    = (m, ttl)=> showToast(m || 'Uwaga ⚠️', 'warn', ttl);

  // Przechwycenie wbudowanego alert(), żeby NIE dotykać app.js
  const nativeAlert = window.alert.bind(window);
  window.alert = function(msg){
    try{
      const s = String(msg || '');
      const lower = s.toLowerCase();
      const isError =
        lower.includes('błąd') ||
        lower.includes('blad') ||
        lower.includes('nie') && lower.includes('moż') ||
        lower.includes('zajęty') ||
        lower.includes('uzupełnij') ||
        lower.includes('invalid');
      const isSuccess =
        lower.includes('dziękuj') ||
        lower.includes('dziekuj') ||
        lower.includes('potwierdzono') ||
        lower.includes('zapisano') ||
        lower.includes('wysłano') || lower.includes('wyslano');

      if(isError)   showError(s);
      else if(isSuccess) showSuccess(s);
      else          showWarn(s);
    }catch(e){
      // w skrajności – pokaż native
      nativeAlert(msg);
    }
  };
})();
</script>

</body>
</html>
