
<!DOCTYPE html>

<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Massages &amp; SPA — Rezerwacja</title>
<link href="assets/style.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<a href="https://www.massagesandspa.pl" class="back-home">← Powrót</a>

</head>
<body>
<div class="container">
<div class="header">
<div class="brand">
<img class="logo" alt="Massage &amp; SPA" src="assets/logo.svg"/>
</div>
</div>
<div class="card">
<h2>Rezerwacja</h2>
<form class="grid two" id="form">
<div>
<label>Imię i nazwisko *</label>
<input class="input" id="name" required=""/>
</div>
<div>
<label>Email *</label>
<input class="input" id="email" required="" type="email"/>
</div>
<div>
<label>Telefon *</label>
<input class="input" id="phone" required="" type="tel"/>
</div>
<div>
<label>Adres</label>
<input class="input" id="address" placeholder="Ulica, miasto"/>
</div>
<div>
<label>Zabieg *</label>
<select class="input" id="service"></select>
</div>
<div>
<label>Data *</label>
<input class="input" id="date" required="" type="text" readonly />
</div>
<div>
<label>Godzina *</label>
<select class="input" id="time"><option>Wybierz datę…</option></select>
</div>
<div class="grid" style="grid-column:1/-1">
<label>Uwagi</label>
<textarea class="input" id="notes" placeholder="Np. preferencje, dolegliwości…" rows="4"></textarea>
</div>
<div class="inline" style="grid-column:1/-1">
<input id="rodo" style="width:18px;height:18px" type="checkbox"/>
<label for="rodo" id="rodoLbl">Wyrażam zgodę na przetwarzanie danych osobowych w celu realizacji rezerwacji.</label>
</div>
<div style="grid-column:1/-1;display:flex;gap:10px">
<button class="btn" type="submit">Rezerwuj</button>
</div>
</form>
</div>
<div class="footer">© Massages &amp; SPA • <span id="contact"></span></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pl.js"></script>
<script>
  // globalnie ustaw polski + poniedziałek
  if (window.flatpickr?.l10ns?.pl) {
    window.flatpickr.localize(window.flatpickr.l10ns.pl);
  }
</script>


<script>
  // SUPABASE → render #service (nadpisujemy select, więc nie będzie duplikatów)
  document.addEventListener('DOMContentLoaded', async () => {
    const sel = document.getElementById('service');
    if (!sel || !window.sb) return;

    try {
      const { data, error } = await window.sb
        .from('services')
        .select('id, name, price, duration_min, active')
        .eq('active', true)
        .order('name', { ascending: true });

      if (error) {
        console.warn('[public] services error:', error);
        return;
      }

      // Nadpisz select – znikają ewentualne stare opcje
      sel.innerHTML = '<option value="">Wybierz zabieg</option>' + 
        (data || []).map(s => {
          const price = (Number(s.price) || 0).toFixed(2).replace('.', ',');
          return `<option value="${s.id}" data-name="${s.name}">${s.name} — ${price} zł</option>`;
        }).join('');

      // (opcjonalnie) Jeżeli Twój app.js ma własny renderer – odśwież go:
      if (typeof window.renderServicesSelect === 'function') {
        window.renderServicesSelect();
      }
    } catch (e) {
      console.warn('[public] services crash:', e);
    }
  });
</script>

<script>
  async function dbLoadServices(){
    const { data, error } = await sb
      .from('services')
      .select('id, name, price, duration_min, active')
      .eq('active', true)
      .order('name', { ascending:true });
    if(error){ console.warn('[public] services error:', error); return []; }
    return data || [];
  }

  async function dbEnsureClient({name, email, phone, address}){
    // spróbuj znaleźć po e-mailu
    let { data: found, error: e1 } = await sb
      .from('clients')
      .select('id')
      .ilike('email', email)
      .single();
    if (!e1 && found) return found.id;

    // jeśli nie ma — utwórz
    const { data: created, error: e2 } = await sb
      .from('clients')
      .insert({ name, email, phone, address })
      .select('id')
      .single();
    if(e2){ console.warn('[public] create client error:', e2); return null; }
    return created?.id || null;
  }

</script>
<script>
  async function dbCreateBooking({
    slot_id, service_id, client_id, notes,
    service_name, client_name, client_email, phone,
    address, booking_no, slot_when
  }){
    // pakiet do inserta
    let ins = {
      slot_id,
      service_id,
      client_id,
      notes: notes || null,
      service_name: service_name || null,
      client_name: client_name || null,
      client_email: client_email || null,
      phone: phone || null,
      address: address || null,       // kolumna 'address' (text)
      booking_no: booking_no || null, // kolumna 'booking_no' (text)
      slot_when: slot_when || null    // kolumna 'slot_when' (timestamptz)
    };

    // podejście 1: z pełnym zestawem pól
    let res = await sb
      .from('bookings')
      .insert(ins)
      .select('id, created_at, booking_no, slot_when')
      .single();

    // fallback, gdyby któraś kolumna nie istniała (kod 42703)
    if (res.error && String(res.error.code) === '42703') {
      if (res.error.message.includes('address'))    delete ins.address;
      if (res.error.message.includes('booking_no')) delete ins.booking_no;
      if (res.error.message.includes('slot_when'))  delete ins.slot_when;

      res = await sb
        .from('bookings')
        .insert(ins)
        .select('id, created_at, booking_no, slot_when')
        .single();
    }

    if (res.error) {
      console.warn('[public] booking insert error:', res.error);
      return { ok: false, error: res.error };
    }
    return { ok: true, booking: res.data };
  }
</script>





<!-- Poprawny baner "dziękujemy" (poza <script>) -->
<style>
/* Pasek potwierdzenia – środek ekranu */
#bookingThanks {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);  /* środek ekranu */
  background: #27ae60;               /* zielony */
  color: #fff;
  padding: 10px 25px;                /* cienki pasek */
  border-radius: 6px;
  font-size: 15px;
  line-height: 1.3;
  display: none;
  z-index: 9999;
  box-shadow: 0 4px 15px rgba(0,0,0,.2);
  white-space: nowrap;               /* jeden wiersz */
}
#bookingThanks.show { display:block; }

</style>
<div id="bookingThanks">Dziękujemy za dokonanie rezerwacji </br> poczekaj na jej potwierdzenie!</div>
<!-- Toast / Banner -->
<div id="toast" style="position:fixed;left:50%;bottom:24px;transform:translateX(-50%) scale(0.98);opacity:0;z-index:9999;min-width:280px;max-width:90vw;padding:14px 18px;border-radius:12px;font:500 14px/1.4 system-ui,-apple-system,'Segoe UI',Roboto; box-shadow:0 8px 30px rgba(0,0,0,.22); transition:opacity .18s ease, transform .18s ease; pointer-events:none;">
  <span id="toast-text"></span>
</div>
<script>
/* Kill legacy slot keys + normalizacja 'slots' */
(function () {
  const LEGACY_KEYS = [
    'FREE_SLOTS', 'FREE_SLOTS_V2', 'freeSlotsISO', 'ms_slots_v6', 'slots_mirror'
  ];
  LEGACY_KEYS.forEach(k => localStorage.removeItem(k));

  // Zostawiamy tylko 'slots' jako źródło prawdy i czyścimy stare/niepoprawne
  let slots = [];
  try { slots = JSON.parse(localStorage.getItem('slots') || '[]'); } catch {}
  slots = (slots || [])
    .map(s => {
      const when = s.when || (s.date && s.time ? `${s.date}T${s.time}:00` : null);
      return when ? { id: s.id, when } : null;
    })
    .filter(Boolean)
    // wyrzuć przeszłość (zostaw tylko przyszłe)
    .filter(s => new Date(s.when).getTime() > Date.now());
  localStorage.setItem('slots', JSON.stringify(slots));

  // Flaga informacyjna – jeśli masz banner debug, pokaże: "klucz: slots"
  window.__SLOTS_KEY__ = 'slots';
})();
</script>
<script>
window.addEventListener('storage', (e) => {
  if (e.key === 'slots') {
    // tu wywołaj swoją funkcję, która przebudowuje mapę dat/godzin
    // np. rebuildCalendarFromSlots();
    // i ewentualnie przeładuj flatpickr:
    if (window.fp && typeof window.fp.redraw === 'function') window.fp.redraw();
  }
});
</script>

<script>
(function(){
  const toast = document.getElementById('toast');
  const text  = document.getElementById('toast-text');
  if(!toast || !text) return;

  function paint(type){
    // tło i kolor na podstawie typu
    const bg = type === 'error' ? 'linear-gradient(135deg, #ff5252, #ff1744)'
            : type === 'warn'  ? 'linear-gradient(135deg, #ffb300, #ff9800)'
            :                    'linear-gradient(135deg, #2ecc71, #27ae60)'; // success
    toast.style.background = bg;
    toast.style.color = '#fff';
  }

  function showToast(msg, type='success', ttl=2600){
    text.textContent = msg;
    paint(type);
    toast.style.opacity = '1';
    toast.style.transform = 'translateX(-50%) scale(1)';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(-50%) scale(0.98)';
    }, ttl);
  }

  // Publiczne API – możesz wywołać z dowolnego miejsca:
  window.showSuccess = (m, ttl)=> showToast(m || 'Gotowe ✅', 'success', ttl);
  window.showError   = (m, ttl)=> showToast(m || 'Wystąpił błąd ❗', 'error', ttl);
  window.showWarn    = (m, ttl)=> showToast(m || 'Uwaga ⚠️', 'warn', ttl);

  // Przechwycenie wbudowanego alert(), żeby NIE dotykać app.js
  const nativeAlert = window.alert.bind(window);
  window.alert = function(msg){
    try{
      const s = String(msg || '');
      const lower = s.toLowerCase();
      const isError =
        lower.includes('błąd') ||
        lower.includes('blad') ||
        lower.includes('nie') && lower.includes('moż') ||
        lower.includes('zajęty') ||
        lower.includes('uzupełnij') ||
        lower.includes('invalid');
      const isSuccess =
        lower.includes('dziękuj') ||
        lower.includes('dziekuj') ||
        lower.includes('potwierdzono') ||
        lower.includes('zapisano') ||
        lower.includes('wysłano') || lower.includes('wyslano');

      if(isError)   showError(s);
      else if(isSuccess) showSuccess(s);
      else          showWarn(s);
    }catch(e){
      // w skrajności – pokaż native
      nativeAlert(msg);
    }
  };
})();
</script><script src="assets/store.js"></script>
<!-- Inicjalizacja Supabase -->

<script>
  // Klient: wywołanie Netlify Function z przeglądarki
  window.sendEmail = async ({ subject, html }) => {
    try {
      const r = await fetch('/.netlify/functions/send-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subject, html })
      });
      const body = await r.text();       // tekst lub JSON-tekst
      if (!r.ok) {
        console.warn('[MAIL] ERR', r.status, body);
        return { ok: false, status: r.status, body };
      }
      return { ok: true, status: r.status, body };
    } catch (e) {
      console.warn('[MAIL] fetch ERR', e);
      return { ok: false, error: e.message };
    }
  };
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const dateInput = document.getElementById('date');
    if (!dateInput) return;

    const fp = flatpickr(dateInput, {
	  locale: 'pl' ,
	  locale: { firstDayOfWeek: 1 },
      dateFormat: 'Y-m-d',
      minDate: 'today',
      onChange: (selectedDates) => {
        if (selectedDates && selectedDates[0]) {
          const d = selectedDates[0];
          const y = d.getFullYear();
          const m = String(d.getMonth()+1).padStart(2,'0');
          const dd = String(d.getDate()).padStart(2,'0');
          const ymdSel = `${y}-${m}-${dd}`;
          if (window.ModCalendar && typeof window.ModCalendar.fillTimes === 'function') {
            window.ModCalendar.fillTimes(ymdSel);
          }
        }
      }
    });

    // opcjonalnie: wstępne wypełnienie jeśli input ma wartość startową
    if (dateInput.value && window.ModCalendar?.fillTimes) {
      window.ModCalendar.fillTimes(dateInput.value);
    }
  });
</script>

<script src="assets/app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="assets/supabase-client.js"></script>
<script src="assets/app.calendar.js"></script>
<script src="assets/cloud-slots-adapter.js"></script>
<script>
  // start: ściągnij sloty i odśwież kalendarz
  document.addEventListener('DOMContentLoaded', async () => {
    if (window.CloudSlots) {
      await window.CloudSlots.pull();
      if (window.fp?.redraw) window.fp.redraw();
      // ustaw pierwszy dzień z wolnymi terminami
      const slots = CloudSlots.get();
      if (slots.length) {
        const d = new Date(slots[0].when);
        const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const dateEl = document.getElementById('date');
        if (dateEl && !dateEl.value) {
          dateEl.value = ymd;
          dateEl.dispatchEvent(new Event('change', { bubbles: true }));
        }
      }
    }
  });
</script>

<script>
  // proste YYYY-MM-DD z czasu lokalnego
  function ymd(d){
    var x = new Date(d);
    var y = x.getFullYear();
    var m = String(x.getMonth()+1).padStart(2,'0');
    var dd= String(x.getDate()).padStart(2,'0');
    return y+'-'+m+'-'+dd;
  }

  function readSlotsFromLS(){
    try { return JSON.parse(localStorage.getItem('slots')||'[]')||[]; }
    catch(_) { return []; }
  }

  // zlicza wolne sloty per dzień (uwzględnia „dziś” > teraz)
  function buildFreeDaysMap(){
    var now = new Date();
    var today = ymd(now);
    var all = (window.CloudSlots && typeof CloudSlots.get==='function')
      ? CloudSlots.get()
      : readSlotsFromLS();

    var map = {};
    for (var i=0;i<all.length;i++){
      var s = all[i];
      if (!s || s.taken || !s.when) continue;
      var d = new Date(s.when);
      var k = ymd(d);
      if (k===today && d.getTime()<=now.getTime()) continue; // przeszłe godziny dziś – pomiń
      map[k] = (map[k]||0) + 1;
    }
    return map;
  }

  // lekki styl do podświetlania
  (function injectCalendarStyles(){
    var style = document.createElement('style');
    style.textContent = `
      .flatpickr-day.has-slots{ box-shadow: inset 0 -2px 0 0 currentColor; color: var(--success); border-color: var(--success); }
      .flatpickr-day.no-slots{ opacity:.45; }
      .flatpickr-day.has-slots::after{ content: attr(data-count); position:absolute; bottom:2px; right:4px; font-size:10px; }
    `;
    document.head.appendChild(style);
  })();

  document.addEventListener('DOMContentLoaded', function(){
    var dateInput = document.getElementById('date');
    if(!dateInput || !window.flatpickr) return;

    var freeMap = buildFreeDaysMap();

    // inicjalizacja flatpickr
    window.fp = flatpickr(dateInput, {
	  locale: 'pl',
	  locale: { firstDayOfWeek: 1 },
      dateFormat: 'Y-m-d',
      minDate: 'today',
	  disableMobile: true,   // wymuś nasz kalendarz zamiast natywnego
      static: true,          // poprawne pozycjonowanie na mobilnych

      onDayCreate: function(dObj, dStr, inst, dayElem){
        var key = ymd(dayElem.dateObj || dObj);
        dayElem.classList.remove('has-slots','no-slots');
        if (freeMap[key]){
          dayElem.classList.add('has-slots');
          dayElem.setAttribute('data-count', freeMap[key]);
        } else {
          dayElem.classList.add('no-slots');
          dayElem.removeAttribute('data-count');
        }
      },
      onMonthChange: function(){ freeMap = buildFreeDaysMap(); },
      onYearChange:  function(){ freeMap = buildFreeDaysMap(); },
      onOpen:        function(){ freeMap = buildFreeDaysMap(); },
      onChange: function(selectedDates){
        var d = selectedDates && selectedDates[0];
        if(!d) return;
        // jeśli masz już działające odświeżanie godzin po zmianie #date — nic nie rób
        // (input dostaje wartość Y-m-d automatycznie)
      }
    });

    // gdy sloty się zaktualizują – przerysuj kalendarz
    window.addEventListener('slots-synced', function(){
      freeMap = buildFreeDaysMap();
      if(window.fp && window.fp.redraw) window.fp.redraw();
    });

    // oraz gdy LS zmieni 'slots' (np. inna karta)
    window.addEventListener('storage', function(e){
      if(e.key==='slots'){
        freeMap = buildFreeDaysMap();
        if(window.fp && window.fp.redraw) window.fp.redraw();
      }
    });
  });
</script>

<script src="assets/app.helpers.js"></script>
<script src="assets/app.booking.js"></script>

<!-- Prosty adapter na stronie publicznej -->
<script>
  window.addEventListener('error', e => {
    console.log('[GLOBAL ERROR]', e.message, 'at', e.filename+':'+e.lineno+':'+e.colno);
  });
  window.addEventListener('unhandledrejection', e => {
    console.log('[PROMISE REJECTION]', e.reason);
  });
</script>
</body>
</html>


