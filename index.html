
<!DOCTYPE html>

<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Massage &amp; SPA — Rezerwacja</title>
<link href="assets/style.css" rel="stylesheet"/>
</head>
<body>
<div class="container">
<div class="header">
<div class="brand">
<img alt="Massage &amp; SPA" src="assets/logo.svg"/>
<h1>Massage &amp; SPA</h1>
</div>
<div>
<a class="btn secondary" href="admin.html">Panel admin</a>
</div>
</div>
<div class="card">
<h2>Rezerwacja</h2>
<form class="grid two" id="form">
<div>
<label>Imię i nazwisko *</label>
<input class="input" id="name" required=""/>
</div>
<div>
<label>Email *</label>
<input class="input" id="email" required="" type="email"/>
</div>
<div>
<label>Telefon *</label>
<input class="input" id="phone" required="" type="tel"/>
</div>
<div>
<label>Adres</label>
<input class="input" id="address" placeholder="Ulica, miasto"/>
</div>
<div>
<label>Zabieg *</label>
<select class="input" id="service"></select>
</div>
<div></div>
<div>
<label>Data *</label>
<input class="input" id="date" required="" type="date"/>
</div>
<div>
<label>Godzina *</label>
<select class="input" id="time"><option>Wybierz datę…</option></select>
</div>
<div class="grid" style="grid-column:1/-1">
<label>Uwagi</label>
<textarea class="input" id="notes" placeholder="Np. preferencje, dolegliwości…" rows="4"></textarea>
</div>
<div class="inline" style="grid-column:1/-1">
<input id="rodo" style="width:18px;height:18px" type="checkbox"/>
<label for="rodo" id="rodoLbl">Wyrażam zgodę na przetwarzanie danych osobowych w celu realizacji rezerwacji.</label>
</div>
<div style="grid-column:1/-1;display:flex;gap:10px">
<button class="btn" type="submit">Rezerwuj</button>
</div>
</form>
</div>
<div class="footer">© Massage &amp; SPA • <span id="contact"></span></div>
</div>
<script src="assets/store.js"></script>
<script src="assets/app.js"></script><script defer="" src="calendar-patch.js"></script><script>(function(){  var DATE_SELECTORS=['#date','#bookingDate','#dateInput','input[name="date"]'];  var TIME_SELECTORS=['#time','#bookingTime','#timeSelect','select[name="time"]'];  function $(list){for(var i=0;i<list.length;i++){var el=document.querySelector(list[i]);if(el)return el}return null}  function injectCSS(css){var s=document.createElement('style');s.textContent=css;document.head.appendChild(s)}  function loadScript(src,cb){var s=document.createElement('script');s.src=src;s.onload=cb;document.head.appendChild(s)}  function loadCSS(href){var l=document.createElement('link');l.rel='stylesheet';l.href=href;document.head.appendChild(l)}  function parseSlots(){    var out=[];function add(d,t){if(!d||!t)return;if(!/^\d{4}-\d{2}-\d{2}$/.test(d))return;if(!/^\d{2}:\d{2}$/.test(t))return;out.push({date:d,time:t})}    for(var i=0;i<localStorage.length;i++){      var k=localStorage.key(i),v=null;try{v=JSON.parse(localStorage.getItem(k))}catch(e){v=null} if(!v)continue;      if(Array.isArray(v)&&v.length){        if(typeof v[0]==='object'&&'date'in v[0]&&'time'in v[0]){v.forEach(function(x){add(x.date,x.time)});continue}        if(typeof v[0]==='string'){v.forEach(function(s){var m=s.match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}:\d{2})$/);if(m)add(m[1],m[2])});continue}      }      if(v&&typeof v==='object'){        if(Array.isArray(v.slots)){v.slots.forEach(function(x){add(x.date,x.time)});continue}        var keys=Object.keys(v),used=false;        for(var j=0;j<keys.length;j++){var key=keys[j];if(/^\d{4}-\d{2}-\d{2}$/.test(key)&&Array.isArray(v[key])){v[key].forEach(function(t){add(key,String(t).slice(0,5))});used=true}}        if(used)continue;      }    }    return out;  }  function init(){    var dateEl=$(DATE_SELECTORS),timeEl=$(TIME_SELECTORS); if(!dateEl||!timeEl)return;    var slots=parseSlots(),days={}; slots.forEach(function(s){(days[s.date]||(days[s.date]=[])).includes(s.time)||days[s.date].push(s.time)});    var enabledDates=Object.keys(days);    if(typeof flatpickr!=='function'){console.warn('flatpickr not loaded');return}    flatpickr(dateEl,{      dateFormat:'Y-m-d',disableMobile:true,enable:enabledDates,      onDayCreate:function(_1,_2,_3,dayElem){        var y=dayElem.dateObj.getFullYear(),m=('0'+(dayElem.dateObj.getMonth()+1)).slice(-2),d=('0'+dayElem.dateObj.getDate()).slice(-2);        var key=y+'-'+m+'-'+d; if(days[key]) dayElem.classList.add('fp-has-slots');      },      onChange:function(selected){var sel=selected&&selected[0]; if(!sel)return;        var y=sel.getFullYear(),m=('0'+(sel.getMonth()+1)).slice(-2),d=('0'+sel.getDate()).slice(-2); var key=y+'-'+m+'-'+d;        while(timeEl.firstChild) timeEl.removeChild(timeEl.firstChild);        var times=(days[key]||[]).slice().sort();        if(!times.length){var o=document.createElement('option');o.value='';o.textContent='Brak wolnych godzin';o.disabled=true;o.selected=true;timeEl.appendChild(o);timeEl.disabled=true;return}        var ph=document.createElement('option');ph.value='';ph.textContent='Wybierz godzinę…';timeEl.appendChild(ph);        times.forEach(function(t){var o=document.createElement('option');o.value=t;o.textContent=t;timeEl.appendChild(o)}); timeEl.disabled=false;      }    });    injectCSS('.flatpickr-day.fp-has-slots{box-shadow:inset 0 0 0 2px rgba(72,222,151,.9);border-radius:8px}.flatpickr-day.fp-has-slots:hover{background:rgba(72,222,151,.15)}');  }  function boot(){    if(typeof flatpickr==='function'){init()}    else{loadCSS('https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css');loadScript('https://cdn.jsdelivr.net/npm/flatpickr',init)}  }  if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',boot);else boot();})();</script>
<script>
(function(){
  // --- 0) Mały pasek diagnostyczny (zobaczysz co się dzieje) ---
  function banner(msg){
    var b=document.getElementById('diagBanner');
    if(!b){ b=document.createElement('div'); b.id='diagBanner';
      b.style.cssText='position:fixed;left:8px;right:8px;bottom:8px;background:#0f1726;color:#cbe7ff;border:1px solid #2a3b5f;padding:8px 10px;border-radius:10px;font:12px/1.4 system-ui,Arial;z-index:9999';
      document.body.appendChild(b);
    }
    b.textContent=msg;
  }

  // --- 1) Znajdź pola (próbujemy kilka wariantów ID/nazw) ---
  function pick(selArr){ for(var i=0;i<selArr.length;i++){ var el=document.querySelector(selArr[i]); if(el) return el; } }
  var dateEl = pick(['#date','#bookingDate','#dateInput','input[name="date"]','input[type="date"]']);
  var timeEl = pick(['#time','#bookingTime','#timeSelect','select[name="time"]','select']);
  if(!dateEl || !timeEl){ banner('Brak pól daty/godziny – sprawdź ID'); return; }

  // --- 2) Wczytaj wolne terminy z różnych kluczy i ujednolić ---
  var CANDIDATE_KEYS = ['FREE_SLOTS_V2','FREE_SLOTS','slots','freeSlotsISO'];
  function loadSlotsAny(){
    var best=[], bestKey='';
    CANDIDATE_KEYS.forEach(function(k){
      try{
        var raw = localStorage.getItem(k); if(!raw) return;
        var arr = JSON.parse(raw); if(!Array.isArray(arr)) return;
        var norm=[];
        arr.forEach(function(x){
          if(!x) return;
          if(typeof x==='string'){ // "YYYY-MM-DD HH:MM"
            var m=x.match(/^(\d{4}-\d{2}-\d{2})[ T](\d{2}:\d{2})$/);
            if(m) norm.push({date:m[1], time:m[2]});
          } else if (x.date && x.time){ // {date,time}
            norm.push({date:String(x.date), time:String(x.time).slice(0,5)});
          }
        });
        if(norm.length>best.length){ best=norm; bestKey=k; }
      }catch(e){}
    });
    // sort
    best.sort(function(a,b){return (a.date+a.time).localeCompare(b.date+b.time)});
    return {slots:best, key:bestKey||'(brak)'};
  }

  var res = loadSlotsAny();
  var SLOTS = res.slots;
  banner('Znaleziono sloty: '+SLOTS.length+' (klucz: '+res.key+')');

  // zbuduj mapę: "YYYY-MM-DD" -> ["HH:MM",...]
  var map={};
  SLOTS.forEach(function(s){ (map[s.date]||(map[s.date]=[])).push(s.time); });
  Object.keys(map).forEach(function(d){ map[d]=Array.from(new Set(map[d])).sort(); });

  // helper do wypełniania godzin
  function fillTimes(dateStr){
    timeEl.innerHTML='';
    var times = map[dateStr]||[];
    if(!times.length){
      var o=document.createElement('option'); o.text='Brak wolnych godzin'; o.value=''; o.disabled=true; o.selected=true;
      timeEl.appendChild(o); timeEl.disabled=true; return;
    }
    var ph=document.createElement('option'); ph.text='Wybierz godzinę…'; ph.value=''; ph.disabled=true; ph.selected=true;
    timeEl.appendChild(ph);
    times.forEach(function(t){ var o=document.createElement('option'); o.value=t; o.text=t; timeEl.appendChild(o); });
    timeEl.disabled=false;
  }
  // placeholder na start
  (function(){ timeEl.innerHTML=''; var o=document.createElement('option'); o.text='Najpierw wybierz datę…'; o.value=''; o.disabled=true; o.selected=true; timeEl.appendChild(o); timeEl.disabled=true; })();

  // --- 3) Flatpickr jeśli jest/jeśli nie – natywny fallback ---
  function fmt(d){var z=n=>('0'+n).slice(-2); return d.getFullYear()+'-'+z(d.getMonth()+1)+'-'+z(d.getDate());}
  var enabledDays = Object.keys(map); // ["YYYY-MM-DD",...]

  function attachNative(){
    // walidacja po wyborze (akceptuj tylko dni z mapy)
    dateEl.addEventListener('change', function(){
      var val = dateEl.value;
      if(!map[val]){ alert('Brak wolnych terminów w tym dniu. Wybierz inny.'); dateEl.value=''; timeEl.innerHTML=''; var o=document.createElement('option'); o.text='Najpierw wybierz datę…'; o.value=''; o.disabled=true; o.selected=true; timeEl.appendChild(o); timeEl.disabled=true; return; }
      fillTimes(val);
    });
   
  }

  function attachFlatpickr(){
    var fp = flatpickr(dateEl, {
      dateFormat:'Y-m-d',
      disableMobile:true,
      enable: function(date){ return !!map[fmt(date)]; },
      onChange: function(dates, str){ if(str) fillTimes(str); },
      onDayCreate: function(_,__,___,dayElem){
        var d = fmt(dayElem.dateObj);
        if(map[d]) dayElem.classList.add('has-slot');
      }
    });
    // auto-set pierwszego dostępnego dnia
    if(enabledDays.length){ fp.setDate(enabledDays[0], true); fillTimes(enabledDays[0]); }
    // delikatny styl
    var css='.flatpickr-day.has-slot{box-shadow:inset 0 0 0 2px rgba(99,255,185,.9);border-radius:8px}';
    var s=document.createElement('style'); s.textContent=css; document.head.appendChild(s);
    banner('Tryb: flatpickr (dni z dostępnością podświetlone)');
  }

  function boot(){
    if(SLOTS.length===0){ banner('Brak zapisanych terminów. Dodaj w panelu admin na tej samej domenie.'); attachNative(); return; }
    if(typeof flatpickr==='function'){ attachFlatpickr(); }
    else { attachNative(); }
  }

  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot); else boot();
})();
</script>
<!-- Poprawny baner "dziękujemy" (poza <script>) -->
<style>
#bookingThanks {
  position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);
  background: #fff; color:#000; border:2px solid #000;
  padding: 14px 18px; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
  display:none; z-index: 9999; text-align:center;
}
#bookingThanks.show { display:block; animation: fadein .18s ease-out; }
@keyframes fadein { from { opacity:0; transform: translateX(-50%) translateY(6px);} to { opacity:1; transform: translateX(-50%) translateY(0);} }
</style>
<div id="bookingThanks">Dziękujemy za dokonanie rezerwacji, poczekaj na jej potwierdzenie!</div>
<script>
(() => {
  const form = document.querySelector('#form');
  if (!form) return;

  function getTextOfSelect(selector) {
    const el = document.querySelector(selector);
    if (el && el.tagName === 'SELECT') {
      const opt = el.options[el.selectedIndex];
      return (opt && opt.text || '').trim();
    }
    return (el && el.value || '').trim();
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const svc = getTextOfSelect('#service');
    const reservation = {
      id: (`0000` + Math.floor(Math.random() *10000)).slice(-4),
      service: svc,
      date: document.querySelector('#date')?.value || '',
      time: document.querySelector('#time')?.value || '',
      notes: document.querySelector('#notes')?.value || '',
      client: {
        name: document.querySelector('#name')?.value || '',
        email: document.querySelector('#email')?.value || '',
        phone: document.querySelector('#phone')?.value || '',
        address: document.querySelector('#address')?.value || ''
      }
    };

    try {
      const res = await fetch('/.netlify/functions/send-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ reservation })
      });
      const text = await res.text();
      let data = {}; try { data = JSON.parse(text); } catch {}
      if (res.ok && data.ok) {
        const b = document.getElementById('bookingThanks');
        if (b) { b.classList.add('show'); setTimeout(()=>b.classList.remove('show'), 3500); }
      } else {
        alert('❌ Błąd wysyłki: ' + (data.error || text || res.status));
      }
    } catch (err) {
      alert('❌ Błąd sieci: ' + err.message);
    }
  });
})();</script><!-- Toast / Banner -->
<div id="toast" style="position:fixed;left:50%;bottom:24px;transform:translateX(-50%) scale(0.98);opacity:0;z-index:9999;min-width:280px;max-width:90vw;padding:14px 18px;border-radius:12px;font:500 14px/1.4 system-ui,-apple-system,'Segoe UI',Roboto; box-shadow:0 8px 30px rgba(0,0,0,.22); transition:opacity .18s ease, transform .18s ease; pointer-events:none;">
  <span id="toast-text"></span>
</div>
<script>
(function(){
  const toast = document.getElementById('toast');
  const text  = document.getElementById('toast-text');
  if(!toast || !text) return;

  function paint(type){
    // tło i kolor na podstawie typu
    const bg = type === 'error' ? 'linear-gradient(135deg, #ff5252, #ff1744)'
            : type === 'warn'  ? 'linear-gradient(135deg, #ffb300, #ff9800)'
            :                    'linear-gradient(135deg, #2ecc71, #27ae60)'; // success
    toast.style.background = bg;
    toast.style.color = '#fff';
  }

  function showToast(msg, type='success', ttl=2600){
    text.textContent = msg;
    paint(type);
    toast.style.opacity = '1';
    toast.style.transform = 'translateX(-50%) scale(1)';
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>{
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(-50%) scale(0.98)';
    }, ttl);
  }

  // Publiczne API – możesz wywołać z dowolnego miejsca:
  window.showSuccess = (m, ttl)=> showToast(m || 'Gotowe ✅', 'success', ttl);
  window.showError   = (m, ttl)=> showToast(m || 'Wystąpił błąd ❗', 'error', ttl);
  window.showWarn    = (m, ttl)=> showToast(m || 'Uwaga ⚠️', 'warn', ttl);

  // Przechwycenie wbudowanego alert(), żeby NIE dotykać app.js
  const nativeAlert = window.alert.bind(window);
  window.alert = function(msg){
    try{
      const s = String(msg || '');
      const lower = s.toLowerCase();
      const isError =
        lower.includes('błąd') ||
        lower.includes('blad') ||
        lower.includes('nie') && lower.includes('moż') ||
        lower.includes('zajęty') ||
        lower.includes('uzupełnij') ||
        lower.includes('invalid');
      const isSuccess =
        lower.includes('dziękuj') ||
        lower.includes('dziekuj') ||
        lower.includes('potwierdzono') ||
        lower.includes('zapisano') ||
        lower.includes('wysłano') || lower.includes('wyslano');

      if(isError)   showError(s);
      else if(isSuccess) showSuccess(s);
      else          showWarn(s);
    }catch(e){
      // w skrajności – pokaż native
      nativeAlert(msg);
    }
  };
})();
</script>
</body>
</html>
