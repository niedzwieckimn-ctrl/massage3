
<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Massage & SPA â€” Panel Admin</title>
  <link rel="stylesheet" href="assets/style.css"/>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <img src="assets/logo.svg" alt="logo"/>
        <h1>Panel admin</h1>
      </div>
      <div class="inline">
        <span class="kbd">DostÄ™p chroniony PIN</span>
        <button id="logoutBtn" class="btn secondary">Wyloguj</button>
      </div>
    </div>

    <!-- Login -->
    <div id="loginView" class="card" style="display:none;max-width:520px;margin:40px auto">
      <h2>WejÅ›cie do panelu</h2>
      <div class="grid two">
        <div style="grid-column:1/-1">
          <label>PIN</label>
          <input id="pin" class="input" type="password" placeholder="np. 2505"/>
        </div>
        <div style="grid-column:1/-1">
          <button id="loginBtn" class="btn">Zaloguj</button>
        </div>
      </div>
    </div>

    <!-- App -->
    <div id="appView" style="display:none">
      <div class="tabbar">
        <div class="tab active" data-tab="dashboard">PrzeglÄ…d</div>
        <div class="tab" data-tab="slots">Terminy</div>
        <div class="tab" data-tab="services">UsÅ‚ugi & Cennik</div>
        <div class="tab" data-tab="clients">Klienci</div>
        <div class="tab" data-tab="settings">Ustawienia</div>
      </div>

      <!-- Dashboard -->
      <div class="card tabpane" data-pane="dashboard">
        <h2>NadchodzÄ…ce wizyty</h2>
        <div id="upcoming" class="grid"></div>
      </div>

      <!-- Slots -->
      <div class="card tabpane" data-pane="slots" style="display:none">
        <h2>Terminy</h2>
        <div class="grid two">
          <div>
            <label>Data</label>
            <input id="slotDate" type="date" class="input"/>
          </div>
          <div>
            <label>Godzina</label>
            <input id="slotTime" type="time" class="input"/>
          </div>
          <div style="grid-column:1/-1">
            <button id="addSlot" class="btn">Dodaj termin</button>
          </div>
        </div>
        <hr class="sep"/>
        <div id="slotsList" class="grid"></div>
      </div>

      <!-- Services -->
      <div class="card tabpane" data-pane="services" style="display:none">
        <h2>UsÅ‚ugi & Cennik</h2>
        <div style="margin:10px 0"><button id="addService" class="btn">Dodaj usÅ‚ugÄ™</button></div>
        <table class="table">
          <thead><tr><th>UsÅ‚uga</th><th>Czas</th><th>Cena</th><th>Akcje</th></tr></thead>
          <tbody id="servicesBody"></tbody>
        </table>
      </div>

      <!-- Clients -->
      <div class="card tabpane" data-pane="clients" style="display:none">
        <h2>Klienci</h2>
        <div id="clientsList" class="grid"></div>
      </div>

      <!-- Settings -->
      <div class="card tabpane" data-pane="settings" style="display:none">
        <h2>Ustawienia</h2>
        <div class="grid two">
          <div>
            <label>Email kontaktowy</label>
            <input id="setEmail" class="input" type="email"/>
          </div>
          <div>
            <label>Telefon kontaktowy</label>
            <input id="setTel" class="input" type="tel"/>
          </div>
          <div style="grid-column:1/-1">
            <label>TreÅ›Ä‡ zgody RODO</label>
            <textarea id="setRodo" class="input" rows="3"></textarea>
          </div>
          <div>
            <label>PIN do panelu</label>
            <input id="setPIN" class="input" type="text"/>
          </div>
          <div style="grid-column:1/-1">
            <button id="saveSettingsBtn" class="btn">Zapisz ustawienia</button>
          </div>
        </div>
      </div>
    </div>
    <div class="footer">Â© Massage &amp; SPA</div>
  </div>

  <!-- Client modal -->
  <div id="clientModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);padding:30px;overflow:auto">
    <div class="card" style="max-width:900px;margin:40px auto">
      <div class="inline" style="justify-content:space-between">
        <h2 id="clientName">Klient</h2>
        <div class="inline">
          <button id="saveClientBtn" class="btn success">Zapisz</button>
          <button id="closeClientBtn" class="btn danger">Zamknij</button>
        </div>
      </div>
      <div class="grid two">
        <div>
          <label>Email</label><input id="cEmail" class="input" type="email"/>
        </div>
        <div>
          <label>Telefon</label><input id="cPhone" class="input" type="tel"/>
        </div>
        <div style="grid-column:1/-1">
          <label>Adres</label><input id="cAddress" class="input"/>
        </div>
        <div style="grid-column:1/-1">
          <label>Notatka ogÃ³lna</label>
          <textarea id="cNotes" class="input" rows="3"></textarea>
        </div>
        <div>
          <label>Uczulenia</label><input id="cPrefAll" class="input"/>
        </div>
        <div>
          <label>Preferencje masaÅ¼u</label><input id="cPrefMassage" class="input"/>
        </div>
        <div>
          <label>Stan zdrowia</label><input id="cPrefHealth" class="input"/>
        </div>
        <div>
          <label>Stan psychiczny</label><input id="cPrefMental" class="input"/>
        </div>
      </div>
      <div class="card">
        <h2>Sugestie terapeutyczne</h2>
        <div id="clientSuggestion" class="small"></div>
      </div>
      <div class="card">
        <h2>Historia zabiegÃ³w</h2>
        <table class="table">
          <thead><tr><th>Data</th><th>Zabieg</th><th>Notatka</th><th>Status</th></tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="assets/store.js"></script>
  <script src="assets/admin.js"></script>
  <script>
    // tab switching
    const tabs = document.querySelectorAll('.tabbar .tab');
    const panes = document.querySelectorAll('.tabpane');
    tabs.forEach(t=> t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const id = t.dataset.tab;
      panes.forEach(p=> p.style.display = (p.dataset.pane===id)?'block':'none');
    }));
  </script><script>
(function(){
  const dateEl = document.getElementById('slotDate')   || document.getElementById('adminDate');
  const timeEl = document.getElementById('slotTime')   || document.getElementById('adminTime');
  const addBtn = document.getElementById('addSlot')    || document.getElementById('addSlotBtn');
  const listEl = document.getElementById('slotsList');
  if(!dateEl || !timeEl || !addBtn || !listEl) return;

  function load(){
    try{ return JSON.parse(localStorage.getItem('slots')||'[]'); }
    catch(e){ return []; }
  }

  function saveMirror(arr){
    const j = JSON.stringify(arr);
    localStorage.setItem('slots', j);
    localStorage.setItem('FREE_SLOTS', j);
    localStorage.setItem('FREE_SLOTS_V2', j);
    localStorage.setItem('freeSlotsISO', JSON.stringify(arr.map(s => `${s.date} ${s.time}`)));

    // DODANE: mapa dat -> listy godzin (dla index.html)
    const map = {};
    arr.forEach(s => { (map[s.date] ||= []).push(s.time); });
    localStorage.setItem('ms_slots_v61', JSON.stringify(map));
  }

  function render(){
    const arr = load().sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
    listEl.innerHTML = '';
    if(!arr.length){
      const empty = document.createElement('div');
      empty.className = 'row';
      empty.textContent = 'Brak dodanych terminÃ³w';
      listEl.appendChild(empty);
      return;
    }
    arr.forEach((s,i)=>{
      const row = document.createElement('div');
      row.className = 'row';
      const dt = new Date(`${s.date}T${s.time}:00`);
      const label = isNaN(dt)
        ? `${s.date} â€¢ ${s.time}`
        : dt.toLocaleString('pl-PL',{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}).replace('.','');
      const span = document.createElement('span'); span.textContent = label;
      const del = document.createElement('button');
      del.className = 'btn danger';
      del.textContent = 'UsuÅ„';
      del.addEventListener('click', ()=>{
        const a = load(); a.splice(i,1); saveMirror(a); render();
      });
      row.appendChild(span); row.appendChild(del);
      listEl.appendChild(row);
    });
  }

  addBtn.addEventListener('click', ()=>{
    const d = (dateEl.value||'').trim();          // YYYY-MM-DD
    const t = (timeEl.value||'').trim().slice(0,5); // HH:MM
    if(!/^\d{4}-\d{2}-\d{2}$/.test(d) || !/^\d{2}:\d{2}$/.test(t)){
      alert('Podaj poprawnÄ… datÄ™ i godzinÄ™.');
      return;
    }
    const arr = load();
    if(arr.some(s => s.date===d && s.time===t)){
      alert('Taki termin juÅ¼ istnieje!');
      return;
    }
    arr.push({date:d, time:t});
    arr.sort((a,b)=>(a.date+a.time).localeCompare(b.date+b.time));
    saveMirror(arr);
    render();
    dateEl.value=''; timeEl.value='';
  });

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', render, { once:true });
  } else {
    render();
  }
})();
</script><script>
// === NadchodzÄ…ce wizyty (localStorage â†’ #upcoming) ===
function lsGet(key, def=[]) { try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); } catch { return def; } }
function fmtDT(d,t){ const x=new Date(`${d}T${t||'00:00'}`); return isNaN(x)?`${d} ${t||''}`:x.toLocaleString('pl-PL',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}).replace('.',''); }

function renderUpcoming(){
  const box = document.getElementById('upcoming'); // <div id="upcoming" ...>
  if (!box) return;

  const bookings = lsGet('bookings').filter(b=>b?.date && b?.time)
    .sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time));

  if (!bookings.length) {
    box.innerHTML = '<div class="row muted">Brak nadchodzÄ…cych wizyt</div>';
    return;
  }

  box.innerHTML = bookings.map(b => {
    const safe = {
      id: b.id || '',
      service: b.service || b.serviceName || '',
      date: b.date || (b.startDateTime||'').slice(0,10),
      time: b.time || (b.startDateTime||'').slice(11,16),
      notes: b.notes || '',
      client: {
        name:  b.client?.name || b.name || '',
        email: b.client?.email || b.email || '',
        phone: b.client?.phone || b.phone || '',
        address: b.client?.address || b.address || ''
      },
      status: b.status || 'pending'
    };
    const payload = encodeURIComponent(JSON.stringify(safe));
    const badge = safe.status === 'confirmed' ? '<span class="badge ok">Potwierdzona</span>' : '<span class="badge muted">Do potwierdzenia</span>';

    return `
      <div class="row booking" data-booking="${payload}">
        <span><b>${fmtDT(safe.date, safe.time)}</b> â€” ${safe.service} ${safe.client.name ? `(<i>${safe.client.name}</i>)` : ''}</span>
        <span class="actions">
          ${badge}
          <button class="btn success" data-action="confirm">PotwierdÅº</button>
          <button class="btn danger"  data-action="delete">UsuÅ„</button>
        </span>
      </div>
    `;
  }).join('');
}

// start
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', renderUpcoming, {once:true});
} else { renderUpcoming(); }
</script>
<script>
// === Akcje: PotwierdÅº / UsuÅ„ ===
document.addEventListener('click', async (e) => {
  // POTWIERDÅ¹
  const btnC = e.target.closest('[data-action="confirm"]');
  if (btnC) {
    const host = btnC.closest('[data-booking]');
    if (!host) return alert('Brak danych rezerwacji');
    let reservation={};
    try { reservation = JSON.parse(decodeURIComponent(host.getAttribute('data-booking')) || '{}'); }
    catch { return alert('BÅ‚Ä™dny JSON data-booking'); }

    if (!reservation?.client?.email) return alert('Brak e-maila klienta');

    try {
      const res = await fetch('/.netlify/functions/send-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mode: 'confirm', reservation })
      });
      const txt = await res.text(); let data={}; try{ data=JSON.parse(txt);}catch{}
      if (res.ok && data.ok === true) {
        // zaznacz w localStorage jako confirmed
        const all = JSON.parse(localStorage.getItem('bookings') || '[]')
          .map(b => (b.id===reservation.id ? {...b, status:'confirmed'} : b));
        localStorage.setItem('bookings', JSON.stringify(all));
        renderUpcoming();
        alert('ðŸ“© Potwierdzenie wysÅ‚ane (admin + klient)');
      } else {
        alert('âŒ BÅ‚Ä…d wysyÅ‚ki ('+res.status+'): ' + (data.error || txt));
      }
    } catch (err) {
      alert('âŒ BÅ‚Ä…d sieci: ' + err.message);
    }
    return;
  }

  // USUÅƒ
  const btnD = e.target.closest('[data-action="delete"]');
  if (btnD) {
    const host = btnD.closest('[data-booking]');
    if (!host) return;
    let resv={}; try { resv = JSON.parse(decodeURIComponent(host.getAttribute('data-booking')) || '{}'); } catch {}
    const all = JSON.parse(localStorage.getItem('bookings') || '[]')
      .filter(b => b.id !== resv.id);
    localStorage.setItem('bookings', JSON.stringify(all));
    renderUpcoming();
    return;
  }
});
</script>

</body>
</html>
