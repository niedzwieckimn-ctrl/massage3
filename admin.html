<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Massage & SPA — Admin</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:0; padding:24px; background:#fafafa; color:#111; }
    .wrap { max-width: 1100px; margin: 0 auto; }
    h1,h2 { margin: 0 0 12px; }
    .card { background:#fff; border:1px solid #e5e5e5; border-radius:12px; padding:16px; margin-bottom:16px; }
    .row  { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:10px 0; border-bottom:1px dashed #eee; }
    .row:last-child { border-bottom:0; }
    .badge{ display:inline-block; padding:4px 8px; border-radius:10px; font-size:12px; color:#fff; background:#666; }
    .badge.ok{ background:#0a7a2f; }
    button{ padding:8px 12px; border:0; border-radius:10px; cursor:pointer; }
    .btn { background:#111; color:#fff; }
    .btn-danger{ background:#b00020; }
    .btn-success{ background:#0a7a2f; }
    .muted{ opacity:.75 }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 800px){ .grid2{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Panel administracyjny</h1>

    <!-- WOLNE TERMINY (zostaw swoje jeśli już masz) -->
    <section class="card">
      <h2>Wolne terminy</h2>
      <div class="grid2">
        <div>
          <label for="slotDate" class="muted">Data</label>
          <input id="slotDate" type="date" />
        </div>
        <div>
          <label for="slotTime" class="muted">Godzina</label>
          <input id="slotTime" type="time" />
        </div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="addSlot" class="btn">Dodaj termin</button>
      </div>
      <div id="slotsList" style="margin-top:12px"></div>
    </section>

    <!-- REZERWACJE OCZEKUJĄCE -->
    <section class="card">
      <h2>Rezerwacje</h2>
      <div id="upcoming"></div>
    </section>

    <!-- REZERWACJE POTWIERDZONE -->
    <section class="card">
      <h2>Potwierdzone rezerwacje</h2>
      <div id="confirmed"></div>
    </section>
  </div>
<!-- Services -->
      <div class="card tabpane" data-pane="services" style="display:none">
        <h2>Usługi & Cennik</h2>
        <div style="margin:10px 0"><button id="addService" class="btn">Dodaj usługę</button></div>
        <table class="table">
          <thead><tr><th>Usługa</th><th>Czas</th><th>Cena</th><th>Akcje</th></tr></thead>
          <tbody id="servicesBody"></tbody>
        </table>
      </div>

      <!-- Clients -->
      <div class="card tabpane" data-pane="clients" style="display:none">
        <h2>Klienci</h2>
        <div id="clientsList" class="grid"></div>
      </div>

      <!-- Settings -->
      <div class="card tabpane" data-pane="settings" style="display:none">
        <h2>Ustawienia</h2>
        <div class="grid two">
          <div>
            <label>Email kontaktowy</label>
            <input id="setEmail" class="input" type="email"/>
          </div>
          <div>
            <label>Telefon kontaktowy</label>
            <input id="setTel" class="input" type="tel"/>
          </div>
          <div style="grid-column:1/-1">
            <label>Treść zgody RODO</label>
            <textarea id="setRodo" class="input" rows="3"></textarea>
          </div>
          <div>
            <label>PIN do panelu</label>
            <input id="setPIN" class="input" type="text"/>
          </div>
          <div style="grid-column:1/-1">
            <button id="saveSettingsBtn" class="btn">Zapisz ustawienia</button>
          </div>
        </div>
      </div>
    </div>
    <div class="footer">© Massage &amp; SPA</div>
  </div>

  <!-- Client modal -->
  <div id="clientModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);padding:30px;overflow:auto">
    <div class="card" style="max-width:900px;margin:40px auto">
      <div class="inline" style="justify-content:space-between">
        <h2 id="clientName">Klient</h2>
        <div class="inline">
          <button id="saveClientBtn" class="btn success">Zapisz</button>
          <button id="closeClientBtn" class="btn danger">Zamknij</button>
        </div>
      </div>
      <div class="grid two">
        <div>
          <label>Email</label><input id="cEmail" class="input" type="email"/>
        </div>
        <div>
          <label>Telefon</label><input id="cPhone" class="input" type="tel"/>
        </div>
        <div style="grid-column:1/-1">
          <label>Adres</label><input id="cAddress" class="input"/>
        </div>
        <div style="grid-column:1/-1">
          <label>Notatka ogólna</label>
          <textarea id="cNotes" class="input" rows="3"></textarea>
        </div>
        <div>
          <label>Uczulenia</label><input id="cPrefAll" class="input"/>
        </div>
        <div>
          <label>Preferencje masażu</label><input id="cPrefMassage" class="input"/>
        </div>
        <div>
          <label>Stan zdrowia</label><input id="cPrefHealth" class="input"/>
        </div>
        <div>
          <label>Stan psychiczny</label><input id="cPrefMental" class="input"/>
        </div>
      </div>
      <div class="card">
        <h2>Sugestie terapeutyczne</h2>
        <div id="clientSuggestion" class="small"></div>
      </div>
      <div class="card">
        <h2>Historia zabiegów</h2>
        <table class="table">
          <thead><tr><th>Data</th><th>Zabieg</th><th>Notatka</th><th>Status</th></tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="assets/store.js"></script>
  <script src="assets/admin.js"></script>
  <script>
  // === STORAGE ============================================================
  function lsGet(k, fb){ try{ return JSON.parse(localStorage.getItem(k) ?? JSON.stringify(fb)); }catch{ return fb; } }
  function lsSet(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  const loadBookings = () => lsGet('bookings', []);
  const saveBookings = (a) => lsSet('bookings', Array.isArray(a)?a:[]);

  // === WOLNE TERMINY (slots) — obsługa mapy i starego formatu ============
  function loadSlotsMap(){
    // preferowany: ms_slots_v6 = { 'YYYY-MM-DD': ['HH:MM', ...] }
    const m = lsGet('ms_slots_v6', null);
    if (m && typeof m === 'object') return m;

    // fallback: FREE_SLOTS_V2 = [{date,time}, ...] -> konwersja na mapę
    const arr = lsGet('FREE_SLOTS_V2', []);
    const map = {};
    arr.forEach(s => { if(s?.date && s?.time){ (map[s.date]??=[]).push(s.time); } });
    return map;
  }
  function saveSlotsMap(map){
    if (!map || typeof map !== 'object') return;
    // zapis w nowym formacie:
    lsSet('ms_slots_v6', map);
    // (opcjonalny) równoległy zapis w starym:
    const flat = [];
    Object.keys(map).forEach(d => map[d].forEach(t => flat.push({date:d,time:t})));
    lsSet('FREE_SLOTS_V2', flat);
  }
  function removeSlot(date, time){
    const map = loadSlotsMap();
    if (!map[date]) return false;
    map[date] = (map[date] || []).filter(t => String(t).slice(0,5) !== String(time).slice(0,5));
    if (map[date].length === 0) delete map[date];
    saveSlotsMap(map);
    // poinformuj index (jeśli otwarty w innej karcie)
    try{ window.dispatchEvent(new StorageEvent('storage', { key:'ms_slots_v6' })); }catch{}
    return true;
  }

  // === RENDER: SLOTY ======================================================
  function renderSlots(){
    const list = document.getElementById('slotsList');
    if (!list) return;
    const map = loadSlotsMap();
    const rows = Object.keys(map).flatMap(d => (map[d]||[]).map(t => ({date:d, time:t})))
                 .sort((a,b) => (`${a.date}T${a.time}`).localeCompare(`${b.date}T${b.time}`));
    list.innerHTML = rows.map(s=>{
      const pretty = new Date(`${s.date}T${s.time}:00`).toLocaleString('pl-PL',{dateStyle:'medium', timeStyle:'short'});
      return `<div class="row">
        <div><strong>${pretty}</strong></div>
        <div><button class="btn btn-danger" data-del="${s.date}|${s.time}">Usuń</button></div>
      </div>`;
    }).join('') || '<div class="muted">Brak wolnych terminów.</div>';
  }

  // === RENDER: REZERWACJE =================================================
  function renderUpcoming(){
    const box = document.getElementById('upcoming');
    if (!box) return;
    const arr = loadBookings()
      .filter(b => String(b?.status||'').toLowerCase() !== 'potwierdzona' && String(b?.status||'').toLowerCase() !== 'confirmed')
      .sort((a,b)=>(`${a.date}T${a.time}`).localeCompare(`${b.date}T${b.time}`));
    box.innerHTML = arr.map(b=>{
      const pretty = (b.date && b.time)
        ? new Date(`${b.date}T${b.time}:00`).toLocaleString('pl-PL',{dateStyle:'medium', timeStyle:'short'})
        : 'Invalid Date';
      return `<div class="row" data-id="${b.id}">
        <div>
          <div><strong>${pretty}</strong> — ${b.service || 'Zabieg'}</div>
          <div class="muted">${b.client?.name || ''} ${b.client?.phone ? '• '+b.client.phone : ''} ${b.client?.email ? '• '+b.client.email : ''}</div>
          ${b.client?.address ? `<div class="muted">${b.client.address}</div>` : ''}
          ${b.notes ? `<div class="muted"><em>${b.notes}</em></div>` : ''}
        </div>
        <div style="display:flex; gap:8px">
          <span class="badge">${b.status || 'Oczekująca'}</span>
          <button class="btn btn-success" data-action="confirm" data-id="${b.id}">Potwierdź</button>
          <button class="btn btn-danger"  data-action="delete"  data-id="${b.id}">Usuń</button>
        </div>
      </div>`;
    }).join('') || '<div class="muted">Brak rezerwacji do potwierdzenia.</div>';
  }

  function renderConfirmed(){
    const box = document.getElementById('confirmed');
    if (!box) return;
    const arr = loadBookings()
      .filter(b => ['potwierdzona','confirmed'].includes(String(b?.status||'').toLowerCase()))
      .sort((a,b)=>(`${a.date}T${a.time}`).localeCompare(`${b.date}T${b.time}`));
    box.innerHTML = arr.map(b=>{
      const pretty = (b.date && b.time)
        ? new Date(`${b.date}T${b.time}:00`).toLocaleString('pl-PL',{dateStyle:'medium', timeStyle:'short'})
        : 'Invalid Date';
      return `<div class="row" data-id="${b.id}">
        <div>
          <div><strong>${pretty}</strong></div>
          <div>${b.service || 'Zabieg'}</div>
          <div class="muted">${b.client?.name || ''} ${b.client?.phone ? '• '+b.client.phone : ''}</div>
          <div class="muted">${b.client?.email || ''}</div>
          <div class="muted">${b.client?.address || ''}</div>
          ${b.notes ? `<div class="muted"><em>${b.notes}</em></div>` : ''}
        </div>
        <span class="badge ok">Potwierdzona</span>
      </div>`;
    }).join('') || '<div class="muted">Brak potwierdzonych rezerwacji.</div>';
  }

  function renderAll(){ renderSlots(); renderUpcoming(); renderConfirmed(); }

  // === MAIL: wysyłka potwierdzenia do klienta ============================
  function buildClientMail(b){
    const pretty = (b.date && b.time)
      ? new Date(`${b.date}T${b.time}:00`).toLocaleString('pl-PL',{dateStyle:'medium', timeStyle:'short'})
      : `${b.date||''} ${b.time||''}`;
    const subject = `Potwierdzenie rezerwacji #${b.id} — ${b.service || 'Usługa'}`;
    const html = `
      <div style="font:14px/1.5 system-ui,-apple-system,'Segoe UI',Roboto;color:#111">
        <h2 style="margin:0 0 12px">Twoja wizyta została <span style="color:#2e7d32">potwierdzona</span></h2>
        <table cellpadding="0" cellspacing="0" style="border-collapse:collapse">
          <tr><td style="padding:6px 12px;color:#666">Nr rezerwacji</td><td style="padding:6px 12px"><b>${b.id}</b></td></tr>
          <tr><td style="padding:6px 12px;color:#666">Usługa</td><td style="padding:6px 12px">${b.service || '-'}</td></tr>
          <tr><td style="padding:6px 12px;color:#666">Data i godzina</td><td style="padding:6px 12px">${pretty}</td></tr>
          <tr><td style="padding:6px 12px;color:#666">Miejsce</td><td style="padding:6px 12px">${b.client?.address ? ('u klienta: '+b.client.address) : '-'}</td></tr>
          ${b.notes ? `<tr><td style="padding:6px 12px;color:#666">Uwagi</td><td style="padding:6px 12px">${b.notes}</td></tr>` : ''}
        </table>
        <p style="margin:16px 0 0">Do zobaczenia!<br>Massage & SPA</p>
      </div>
    `;
    return { subject, html };
  }

  async function sendConfirmEmail(b){
    const email = b?.client?.email;
    if (!email) return; // brak maila – nic nie wysyłamy
    const { subject, html } = buildClientMail(b);

    // 1) spróbuj prosty tryb: { to, subject, html }
    try{
      const r = await fetch('/.netlify/functions/send-email', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ to: email, subject, html })
      });
      if (r.ok) return true;
    }catch{}

    // 2) fallback: { reservation, sendToClient:true } — jeśli backend tak obsługuje
    try{
      const r2 = await fetch('/.netlify/functions/send-email', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ reservation: b, sendToClient: true })
      });
      if (r2.ok) return true;
    }catch{}

    return false;
  }

  // === ZDARZENIA (kliknięcia) ============================================
  document.addEventListener('click', async (e) => {
    const delBtn = e.target.closest('[data-del]');
    if (delBtn) {
      const [d,t] = String(delBtn.dataset.del||'|').split('|');
      if (d && t) { removeSlot(d,t); renderSlots(); }
      return;
    }

    const actBtn = e.target.closest('[data-action]');
    if (!actBtn) return;
    const id = actBtn.dataset.id;

    // Załaduj aktualny stan rezerwacji
    const all = loadBookings();
    const i = all.findIndex(b => String(b.id) === String(id));
    if (i === -1) return;

    if (actBtn.dataset.action === 'delete') {
      all.splice(i,1);
      saveBookings(all);
      renderAll();
      return;
    }

    if (actBtn.dataset.action === 'confirm') {
      const b = all[i];
      b.status = 'Potwierdzona';
      b.confirmedAt = new Date().toISOString();
      all[i] = b;
      saveBookings(all);

      // zdejmij slot z wolnych terminów (żeby zniknął z kalendarza index)
      if (b.date && b.time) removeSlot(b.date, b.time);

      // mail do klienta
      const ok = await sendConfirmEmail(b);
      if (ok) {
        (window.showSuccess || alert)('Potwierdzono i wysłano e-mail do klienta.');
      } else {
        (window.showWarn || alert)('Potwierdzono. Wysyłka e-mail do klienta nie powiodła się.');
      }

      renderAll();
      return;
    }
  });

  // === DODAWANIE SLOTÓW ===================================================
  document.getElementById('addSlot')?.addEventListener('click', () => {
    const d = (document.getElementById('slotDate')?.value || '').trim();
    const t = (document.getElementById('slotTime')?.value || '').trim();
    if (!/^\d{4}-\d{2}-\d{2}$/.test(d) || !/^\d{2}:\d{2}$/.test(t)) {
      (window.showError || alert)('Podaj poprawną datę (RRRR-MM-DD) i godzinę (GG:MM).');
      return;
    }
    const map = loadSlotsMap();
    map[d] = Array.from(new Set([...(map[d]||[]), t])).sort();
    saveSlotsMap(map);
    renderSlots();
    // powiadom index (inna karta)
    try{ window.dispatchEvent(new StorageEvent('storage', { key:'ms_slots_v6' })); }catch{}
  });

  // === START ==============================================================
  document.addEventListener('DOMContentLoaded', renderAll);
  window.addEventListener('storage', (e)=> {
    if (['bookings','ms_slots_v6','FREE_SLOTS_V2'].includes(e.key)) renderAll();
  });
  </script>
</body>
</html>
